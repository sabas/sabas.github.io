---
title: GeoJSON Edit
layout: default
---

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>


<script src="https://cdn.rawgit.com/mindmup/editable-table/master/mindmup-editabletable.js"></script>

<div class="container">
<div class="row">
	<h1>GeoJSON editor</h1>
	<p></p>
</div>
<div class="row" id="stepUpload">
<form class="form-inline" action="#">
<input type="file" id="fileUpload" class="form-control"/>
</form>
</div>

<div class="row" id="stepEdit">
<table id="contentTable" class="table table-striped">
<thead></thead>
<tbody></tbody>
</table>
</div>
<div class="row">
<form class="form-inline">
<input type="text" id="fileName" value="" class="form-control"/>
<input type="checkbox" id="completeKeys" checked/> Persist empty cells
<button onclick='saveGeojson()' class="btn btn-primary">Save</button>
</form>
</div>
</div>
<script>
  function handleFileSelect(evt) {
    var files = evt.target.files;
    
    console.log(files[0]);
    $('#fileName').val(files[0].name);
    var reader = new FileReader();

    reader.onload = (function(theFile) {
        return function(e) {
            loadGeojsonInTable(JSON.parse(e.currentTarget.result));
        };
    })(files[0]);

    reader.readAsText(files[0]);
  }

document.getElementById('fileUpload').addEventListener('change', handleFileSelect, false);

function loadGeojsonInTable(json) {

    console.log(json);
    var tempkeys=[];
    var temparray=[];
    tempkeys.push("@geometry");

    $.each(json.features,function(i,v){

        var prop=v.properties;
        var temprow={};
        temprow["@geometry"]=JSON.stringify(v.geometry);

        $.each(prop,function(k,v){
            if (tempkeys.indexOf(k) == -1) {
               tempkeys.push(k);
            }
            temprow[k]=v;
        });
        temparray.push(temprow);
    });
    console.log(temparray);

    tempkeys.sort();
    temphead = '<tr>';
    $.each(tempkeys,function(j,k) {
        
            temphead += '<th>'+k+'</th>';
    });
    temphead += '</tr>';
    $('#contentTable thead').append(temphead);
 
    $.each(temparray,function(i,v) {
        var temphtml='<tr>';
        $.each(tempkeys,function(j,k) {
            if (v[k] === undefined) {
                temphtml+='<td></td>';
            } else {
                temphtml+='<td>'+v[k]+'</td>';
            }
        });
        temphtml += '</tr>';
        $('#contentTable tbody').append(temphtml);
    });

    $('#contentTable').editableTableWidget({editor: $('<textarea>')});
}

function saveGeojson() {
    var fileName = $('#fileName').val();
    var completeKeys = $('#completeKeys').is(':checked');
    
    var tempGeojson = { "type": "FeatureCollection", "features": [] };
    
    console.log(fileName); console.log(completeKeys);
    
    var keyArray = [];
    
    $('#contentTable thead tr th').each(function(i,v) {
        keyArray.push(v.innerText);
    });
    console.log(keyArray);
    $('#contentTable tbody tr').each(function(i, v) {
        var tempFeature = { "type": "Feature", "properties": {}, "geometry": {} };
        $(v).find('td').each(function(j, k) {
            if (keyArray[j] === "@geometry") {
                tempFeature['geometry'] = JSON.parse(k.innerText);
                return;
            }
            var tempValue = k.innerText;
            if (!completeKeys && tempValue == "") {
                return;
            }
            tempFeature['properties'][keyArray[j]] = tempValue;
            console.log(keyArray[j], k.innerText);
        });
        tempGeojson['features'].push(tempFeature);
    });

    var txt = JSON.stringify(tempGeojson);
    console.log(txt);
    var blob = new Blob([txt], {type: "application/vnd.geo+json;charset=utf-8"});
    saveAs(blob, fileName);
}
</script>
