---
title: GeoJSON Edit
layout: default
---

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.29.0/handsontable.full.min.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/handsontable/0.29.0/handsontable.full.min.js"></script>

<div class="container">
<div class="row">
	<h1>GeoJSON editor</h1>
	<p></p>
</div>
<div class="row" id="stepUpload">
<div class="col-md-6">
<form class="form-inline" action="#">
<input type="file" id="fileUpload" class="form-control"/>
</form>
</div>
<div class="col-md-6">
</div>
</div>

<div class="row" >
<div id="stepEdit"></div>
</div>
<div class="row">
<div class="form-inline">
<input type="text" id="fileName" value="" class="form-control"/>
<input type="checkbox" id="completeKeys" checked/> Persist empty cells
<button onclick='saveGeojson();' class="btn btn-primary">Save</button>
</div>
</div>
</div>
<script>
  function handleFileSelect(evt) {
    var files = evt.target.files;
    
    console.log(files[0]);
    $('#fileName').val(files[0].name);
    var reader = new FileReader();

    reader.onload = (function(theFile) {
        return function(e) {
            loadGeojsonInTable(JSON.parse(e.currentTarget.result));
        };
    })(files[0]);

    reader.readAsText(files[0]);
  }

document.getElementById('fileUpload').addEventListener('change', handleFileSelect, false);

var tempkeys=[];
var hot;

function loadGeojsonInTable(json) {
    //reset data
    $('#stepEdit').html('');
    $(".htContextMenu").remove();
    tempkeys = [];
   
    var temparray=[];
    tempkeys.push("@geometry");

    $.each(json.features,function(i,v){

        var prop=v.properties;
        var temprow={};
        temprow["@geometry"]=JSON.stringify(v.geometry);

        $.each(prop,function(k,v){
            if (tempkeys.indexOf(k) == -1) {
               tempkeys.push(k);
            }
            temprow[k]=v;
        });
        temparray.push(temprow);
    });


    tempkeys.sort();
    
    var dataColumns = [];
    for (key in tempkeys) {
        dataColumns.push({data: tempkeys[key], type: 'text', width: 100});
    }

 
  var hotElement = document.querySelector('#stepEdit');
  var hotElementContainer = hotElement.parentNode;
  var hotSettings = {
    data: temparray,
    columns: dataColumns,
    stretchH: 'all',
    width: '100%',
    autoWrapRow: true,
    height: 300,
    maxRows: 22,
    rowHeaders: true,
    colHeaders: tempkeys,
    contextMenu: true
};

  hot = new Handsontable(hotElement, hotSettings);

}

function saveGeojson() {
    var fileName = $('#fileName').val();
    var completeKeys = $('#completeKeys').is(':checked');
    
    var tempGeojson = { "type": "FeatureCollection", "features": [] };

    var data = hot.getData();
    var headers = hot.getColHeader();
        var tempFeature = { "type": "Feature", "properties": {}, "geometry": {} };

        $(data).each(function(j, k) {
        $(k).each(function(l, v) {
            if (headers[l] === "@geometry") {
                tempFeature['geometry'] = JSON.parse(v);
                return;
            }
            if (!completeKeys && v == "") {
                return;
            }
            tempFeature['properties'][headers[l]] = v;
        });
        tempGeojson['features'].push(tempFeature);
     });
    var txt = JSON.stringify(tempGeojson);
    console.log(txt);
    var blob = new Blob([txt], {type: "application/vnd.geo+json;charset=utf-8"});
   saveAs(blob, fileName);

}
</script>
