<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Genoa Port Statistics - 2012 Traffic</title>
<link rel="stylesheet" href="../vendor/css/normalize.css" type="text/css"/>
<script type="text/javascript" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="../vendor/js/FileSaver.js"></script>
<script type="text/javascript">
//https://code.google.com/p/microajax/
function microAjax(B,A){this.bindFunction=function(E,D){return function(){return E.apply(D,[D])}};this.stateChange=function(D){if(this.request.readyState==4){this.callbackFunction(this.request.responseText)}};this.getRequest=function(){if(window.ActiveXObject){return new ActiveXObject("Microsoft.XMLHTTP")}else{if(window.XMLHttpRequest){return new XMLHttpRequest()}}return false};this.postBody=(arguments[2]||"");this.callbackFunction=A;this.url=B;this.request=this.getRequest();if(this.request){var C=this.request;C.onreadystatechange=this.bindFunction(this.stateChange,this);if(this.postBody!==""){C.open("POST",B,true);C.setRequestHeader("X-Requested-With","XMLHttpRequest"); C.setRequestHeader("Content-type","application/x-www-form-urlencoded");C.setRequestHeader("Connection","close")}else{C.open("GET",B,true)}C.send(this.postBody)}};
</script>
</head>
<body>
<p>Genera un csv a partire da un geojson contenente punti, inserendo coordinate nelle prime due colonne e a seguire le propriet√†.</p>
<p>Nel box sotto viene visualizzato il risultato, con Salva viene scaricato il file.</p>

<script>
var tempkeys=[];
var temparray=[];

var tempcsv='';
function geo2csv(json)
{
    var first=true;
    tempkeys.push("lon");
    tempkeys.push("lat");
    
	$.each(json.features,function(i,v){
	var geo=v.geometry.coordinates;
    var prop=v.properties;
    
    var temprow={};
    temprow["lon"]=geo[0];
    temprow["lat"]=geo[1];

        $.each(prop,function(k,v){
        if (tempkeys.indexOf(k) == -1) {
           tempkeys.push(k);
        } 
        temprow[k]=v;
        });
        temparray.push(temprow);
    });
    
tempcsv='"'+tempkeys.join('","')+'"\n';
$.each(temparray,function(k,v){
tempr=''; 
for (var tk=0;tk<tempkeys.length;tk++){
if (tempkeys[tk] in v) {
if(tk>0)tempr+=',';
tempr+='"'+v[tempkeys[tk]]+'"';
}
else tempr+=',';
}
tempcsv+=tempr+"\n";
});
	return tempcsv;
}

function nl2br(str, is_xhtml) {
  //http://phpjs.org/functions/nl2br/
  var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br ' + '/>' : '<br>'; // Adjust comment to avoid issue on phpjs.org display
  return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2');
}

function jsload()
{
    var f= document.getElementById("files").files[0];
    if (f) 
    {
        var r = new FileReader();
        r.onload = function(e) 
        { 
		    var obj=JSON.parse(e.target.result);
			var l=geo2csv(obj); 
			$('#map').html(nl2br(l,true));
        }
            
		r.readAsText(f);
    }
    else { alert ( "Failed to load file" ); }
}

function jssave()
{
var txt= tempcsv;//$("#map").html();
if(txt=="")return;
var blob = new Blob([txt], {type: "text/javascript;charset=utf-8"});
saveAs(blob, "map.csv");
}

</script>

<input type="file" id="files" name="files" />
<input type="button" onclick="jsload()" value="Carica"/>
<input type="button" name="save" id="save" value="Salva" onclick="jssave()"/>
<div id="map" style="height:500px;width:100%; overflow:scroll;"></div>
</body>
</html>
