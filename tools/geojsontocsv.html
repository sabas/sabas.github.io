<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>GeoJson to csv</title>
<link rel="stylesheet" href="../vendor/css/normalize.css" type="text/css"/>
<script type="text/javascript" src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="../vendor/js/FileSaver.js"></script>
</head>
<body>
<h1>GeoJson to csv</h1>
<p>Generate a csv from a geojson file with points: first two columns get the coordinates, then a key per column.</p>
<p>In the box you'll find the result, with Save you download the file.</p>

<script>
var tempkeys=[];
var temparray=[];

var tempcsv='';

/*
 * Funzione principale
 * crea un array di chiavi ed un array con tutte le righe
 * poi lo trasforma in stringa
 */
function geo2csv(json)
{
    var first=true;
    tempkeys.push("lon");
    tempkeys.push("lat");
    
	$.each(json.features,function(i,v){
	var geo=v.geometry.coordinates;
    var prop=v.properties;
    
    var temprow={};
    temprow["lon"]=geo[0];
    temprow["lat"]=geo[1];

        $.each(prop,function(k,v){
        if (tempkeys.indexOf(k) == -1) {
           tempkeys.push(k);
        } 
        temprow[k]=v;
        });
        temparray.push(temprow);
    });
    
    tempcsv='"'+tempkeys.join('","')+'"\n';
    $.each(temparray,function(k,v){
    tempr=''; 
    for (var tk=0;tk<tempkeys.length;tk++){
    if (tempkeys[tk] in v) {
    if(tk>0)tempr+=',';
    tempr+='"'+v[tempkeys[tk]]+'"';
    }
    else tempr+=',';
    }
    tempcsv+=tempr+"\n";
    });
	return tempcsv;
}

//converte gli accapi nel tag html
function nl2br(str, is_xhtml) {
  //http://phpjs.org/functions/nl2br/
  var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br ' + '/>' : '<br>'; // Adjust comment to avoid issue on phpjs.org display
  return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + breakTag + '$2');
}

//carica il file
function jsload()
{
    var f= document.getElementById("files").files[0];
    if (f) 
    {
        var r = new FileReader();
        r.onload = function(e) 
        { 
		    var obj=JSON.parse(e.target.result);
			var l=geo2csv(obj); 
			$('#map').html(nl2br(l,true));
        }
            
		r.readAsText(f);
    }
    else { alert ( "Failed to load file" ); }
}

//salva il testo in un file e lo scarica
function jssave()
{
var txt= tempcsv;
if(txt=="")return;
var blob = new Blob([txt], {type: "text/javascript;charset=utf-8"});
saveAs(blob, "map.csv");
}
</script>
<form>
<input type="file" id="files" name="files" />
<input type="button" onclick="jsload()" value="Execute"/>
<input type="button" name="save" id="save" value="Save" onclick="jssave()"/>
</form>
<div id="map" style="margin-top:20px;height:400px;width:100%; overflow:auto;"></div>
</body>
</html>
